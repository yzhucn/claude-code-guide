# Bug 修复与功能增强: 2026-01-09

> 月报脚本函数调用类型错误修复 + 仪表盘时间范围优化

---

## 问题 1: 月报脚本数据统计错误

### 现象描述

月报（`monthly-report.py`）生成后，深夜提交和周末提交的统计数据不准确，或统计结果全为 0。

### 排查过程

**Step 1: 对比其他脚本**

检查 `daily-report.py` 和 `weekly-report.py` 的实现，发现它们都能正常统计深夜/周末提交。

**Step 2: 查看函数定义**

检查 `utils.py` 中的函数签名：
```python
def is_late_night(time_str: str, config: Dict) -> bool:
    """判断是否深夜提交"""
    time = parse_iso_datetime(time_str)  # 期望字符串参数
    ...

def is_weekend(time_str: str) -> bool:
    """判断是否周末提交"""
    time = parse_iso_datetime(time_str)  # 期望字符串参数
    ...
```

**Step 3: 对比调用方式**

正确用法（`daily-report.py`, `weekly-report.py`）：
```python
is_late_night(commit['date'], self.config)  # ✅ 传入字符串
is_weekend(commit['date'])                  # ✅ 传入字符串
```

错误用法（`monthly-report.py`）：
```python
is_late_night(parse_iso_datetime(c['date']), self.config)  # ❌ 传入 datetime 对象
is_weekend(parse_iso_datetime(c['date']))                  # ❌ 传入 datetime 对象
```

### 根本原因

**Python 动态类型的隐患**

1. **函数期望字符串，实际传入 datetime 对象**
   - `is_late_night()` 和 `is_weekend()` 函数内部会调用 `parse_iso_datetime()`
   - 如果外部已经解析了 datetime 对象并传入，会导致二次解析失败

2. **静默失败**
   - 函数内部有 `try-except` 捕获异常，返回 `False`
   - 这导致错误的调用不会报错，而是返回错误结果（所有提交都不是深夜/周末）

3. **字段名不一致**
   - `monthly-report.py` 还使用了 `commit_date` 字段
   - 但 `GitAnalyzer.get_commits()` 返回的是 `date` 字段

### 解决方案

**修复 1: 统一参数类型**

```diff
# 第 405-406 行
-late_night = len([c for c in all_commits if is_late_night(parse_iso_datetime(c['date']), self.config)])
-weekend = len([c for c in all_commits if is_weekend(parse_iso_datetime(c['date']))])
+late_night = len([c for c in all_commits if is_late_night(c['date'], self.config)])
+weekend = len([c for c in all_commits if is_weekend(c['date'])])

# 第 435-437 行
-if is_weekend(commit_dt):
-elif is_late_night(commit_dt, self.config):
+if is_weekend(commit['date']):
+elif is_late_night(commit['date'], self.config):

# 第 479-482 行（类似修复）
# 第 586-587 行（类似修复）
```

**修复 2: 统一字段名**

```diff
# 第 234 行
-date = commit['commit_date'][:10]
+date = commit['date'][:10]

# 第 354 行
-commit_date = datetime.strptime(commit['commit_date'][:10], '%Y-%m-%d')
+commit_date = datetime.strptime(commit['date'][:10], '%Y-%m-%d')
```

### 经验总结

**技术要点**：

1. **类型一致性是契约**
   - Python 动态类型虽然灵活，但函数签名就是契约
   - 调用前务必确认参数类型符合签名要求

2. **参考已有实现**
   - 同一项目中已有正确用法，新代码应保持一致
   - `daily-report.py` 和 `weekly-report.py` 都是正确的参考

3. **try-except 的双刃剑**
   - 静默失败会掩盖真正的 bug
   - 返回默认值（False）导致数据不准确而非报错
   - 建议添加日志记录异常情况

**避坑指南**：
- ❌ 不要假设函数会自动处理类型转换
- ✅ 查看函数签名确认参数类型
- ✅ 参考同一项目中其他调用点的用法
- ✅ 重复调用相同函数时，确保调用方式一致

---

## 功能 1: 仪表盘时间范围优化

### 需求背景

原仪表盘使用按钮组切换时间范围，存在以下问题：
1. 占用空间大，5 个按钮横向排列拥挤
2. 无法返回报告中心，需要手动修改 URL
3. 无法查看项目全周期数据
4. 项目运行不足 90 天时，仍显示"最近 90 天"按钮（会跳转到项目开始前）

### 解决方案

**改进 1: 下拉菜单替代按钮组**

Before（按钮组）:
```html
<button>最近7天</button>
<button>最近14天</button>
<button>最近30天</button>
<button>最近60天</button>
<button>最近90天</button>
```

After（下拉菜单）:
```html
<select onchange="handleRangeChange(this.value)">
  <option value="/reports/index.html">🏠 返回报告中心</option>
  <option value="index-7d.html">最近7天</option>
  <option value="index.html" selected>最近30天</option>
  <option value="index-60d.html">最近60天</option>
  <option value="index-90d.html">最近90天</option>
  <option value="index-all.html">📅 项目全周期 (120天)</option>
</select>
```

**改进 2: 智能过滤选项**

```python
# 计算项目运行总天数
if data['all_commits']:
    earliest_commit = min(data['all_commits'], key=lambda c: c['date'])
    project_start_date = parse_iso_datetime(earliest_commit['date']).date()
    project_days = (datetime.now().date() - project_start_date).days + 1

# 智能过滤：项目运行天数 < 90 时，不显示"最近 90 天"
preset_ranges = [7, 14, 30, 60, 90]
for days in preset_ranges:
    if project_days and days > project_days:
        continue  # 跳过超出项目运行天数的选项
```

**改进 3: 添加项目全周期选项**

```python
# 添加项目全周期选项
if project_days and project_start_date:
    is_all = (days_count == project_days)
    range_options.append({
        'value': 'index-all.html',
        'label': f'📅 项目全周期 ({project_days}天)',
        'selected': is_all
    })
```

### 用户体验提升

| 功能 | Before | After |
|------|--------|-------|
| 空间占用 | 大（5 个按钮横排） | 小（1 个下拉框） |
| 返回报告中心 | 手动修改 URL | 下拉菜单一键选择 |
| 查看全周期 | 无法实现 | "项目全周期"选项 |
| 选项合理性 | 固定显示 5 个 | 根据项目天数智能过滤 |
| 当前选中 | 按钮 active 样式 | 下拉框 selected 状态 |

---

## 文档更新

### 故障排查指南

在 `.code-health/docs/troubleshooting.md` 中新增第 6 章节：

```markdown
## 6. 月报脚本数据统计错误

### 现象
月报中深夜/周末提交统计数据不准确，或统计结果全为 0。

### 原因分析
函数调用时传入了错误的参数类型：
- ❌ 传入 datetime 对象
- ✅ 应传入字符串

### 解决方案
检查 `monthly-report.py` 中的函数调用，确保传入字符串而非 datetime 对象。
```

---

## 今日成果

### Bug 修复（2 个）
1. ✅ 月报函数调用类型错误（4 处修复）
2. ✅ 月报 commit 字段名不一致（2 处修复）

### 功能增强（2 个）
1. ✅ Dashboard 快速报告入口（动态链接卡片）
2. ✅ 仪表盘时间范围下拉菜单（智能过滤 + 返回中心 + 全周期）

### 文档更新（2 处）
1. ✅ 故障排查指南新增章节
2. ✅ 知识库 Bug 记录更新（Bug #11, #12）

---

## 相关文件

**代码修复**:
- `scripts/monthly-report.py` - 修复函数调用类型错误和字段名
- `scripts/dashboard-generator-range.py` - 仪表盘下拉菜单优化

**文档更新**:
- `docs/troubleshooting.md` - 新增月报脚本错误章节
- `knowledgebase/projects/code-health/bug-fixes/2026-01.md` - Bug 记录

**提交记录**:
- `d06052e` - feat(dashboard): 添加快速报告入口 + fix(monthly): 修复字段名
- `ee84066` - docs: 更新故障排查指南
- `1cd46e8` - feat(dashboard): 优化时间范围切换为下拉菜单

---

## 核心收获

### 1. 类型系统的重要性

Python 的动态类型虽然灵活，但在团队协作中容易引入类型不匹配的 bug。

**教训**：
- 函数签名中的类型注解是契约，调用时务必遵守
- 重复调用相同函数时，确保调用方式一致
- 新增代码时参考已有的正确实现

### 2. 用户体验优化思路

**下拉菜单 vs 按钮组**：
- 下拉菜单适合选项较多且只能单选的场景
- 按钮组适合选项较少且需要快速切换的场景
- 本例中下拉菜单更优：占用空间小、分类清晰、可扩展

**智能适配**：
- 根据实际数据动态调整 UI（项目运行天数过滤）
- 避免误导用户（不显示不合理的选项）

### 3. 文档即时更新

发现和修复 bug 后，立即更新故障排查文档：
- 方便后续遇到类似问题时快速定位
- 积累团队的问题解决知识库
- 提升新成员的上手效率

---

**记录时间**: 2026-01-09
**开发耗时**: 约 2 小时
**核心收获**: Python 动态类型的类型一致性陷阱
