# æ•…éšœæ’æŸ¥æ¡ˆä¾‹: 2026-01-08

> é’‰é’‰æ—¥æŠ¥æ•°æ®å…¨ä¸º 0 + è„šæœ¬å¼‚å¸¸é€€å‡ºçš„æ’æŸ¥ä¸ä¿®å¤

---

## é—®é¢˜ 1: é’‰é’‰æ¶ˆæ¯æ•°æ®å…¨ä¸º 0

### ç°è±¡æè¿°

æ—©ä¸Š 8:00 æ”¶åˆ°çš„é’‰é’‰æ—¥æŠ¥æ¶ˆæ¯ï¼Œæ‰€æœ‰æ•°æ®æ˜¾ç¤ºä¸º 0ï¼š
```
ä»Šæ—¥æäº¤: 0 æ¬¡
ä»£ç å˜æ›´: +0 / -0
å¼€å‘è€…æ•°é‡: 0 äºº
```

### æ’æŸ¥è¿‡ç¨‹

**Step 1: æ£€æŸ¥æ—¥æŠ¥æ–‡ä»¶**
```bash
ls -la /opt/ecomind/.code-health/reports/daily/2026-01-08.md
# ç»“æœ: æ–‡ä»¶å­˜åœ¨ä½†æ•°æ®ä¸ºç©º
```

**Step 2: æ£€æŸ¥å…‹éš†æ—¥å¿—**
```bash
tail -50 /opt/ecomind/.code-health/reports/clone.log
# å‘ç°: "æœªæ‰¾åˆ° repos-list.txt æ–‡ä»¶"
```

**Step 3: ç¡®è®¤æ ¹æœ¬åŸå› **
```bash
ls -la /opt/ecomind/.code-health/repos-list.txt
# ç»“æœ: æ–‡ä»¶ä¸å­˜åœ¨ï¼
```

### æ ¹æœ¬åŸå› 

`repos-list.txt` æ–‡ä»¶åœ¨æŸæ¬¡æ›´æ–°ä¸­è¢«æ„å¤–åˆ é™¤ï¼Œå¯¼è‡´å…‹éš†è„šæœ¬æ— æ³•è·å–ä»“åº“åˆ—è¡¨ï¼Œè¿›è€Œæ— æ³•ç”Ÿæˆæ—¥æŠ¥æ•°æ®ã€‚

### è§£å†³æ–¹æ¡ˆ

```bash
# 1. ä»æœ¬åœ°ä¸Šä¼  repos-list.txt
scp repos-list.txt root@<ECS_IP>:/opt/ecomind/.code-health/

# 2. é‡æ–°è¿è¡Œå…‹éš†å’Œæ—¥æŠ¥ç”Ÿæˆ
ssh root@<ECS_IP> "source /etc/environment && \
  cd /opt/ecomind/.code-health/scripts && \
  bash daily-prepare.sh"
```

### é¢„é˜²æªæ–½

1. åˆ›å»º `sync-repos-list.py` è‡ªåŠ¨å‘ç°è„šæœ¬ï¼Œé€šè¿‡ API è·å–ä»“åº“åˆ—è¡¨
2. åœ¨å…‹éš†è„šæœ¬ä¸­å¢åŠ ä»“åº“æ•°ä¸º 0 çš„å‘Šè­¦

---

## é—®é¢˜ 2: å…‹éš†è„šæœ¬åªå¤„ç†ç¬¬ä¸€ä¸ªä»“åº“

### ç°è±¡æè¿°

è¿è¡Œ `auto-clone-repos.sh` åï¼Œåªå…‹éš†äº†ç¬¬ä¸€ä¸ªä»“åº“å°±é€€å‡ºï¼Œæ—¥å¿—æ˜¾ç¤ºï¼š
```
âœ… æ£€æµ‹åˆ° GIT_TOKEN ç¯å¢ƒå˜é‡
ğŸ“¦ å…‹éš†ä»“åº“: ecomind-infra
  âœ… å…‹éš†æˆåŠŸ
(è„šæœ¬ç»ˆæ­¢ï¼Œæ²¡æœ‰å¤„ç†åç»­ä»“åº“)
```

### æ’æŸ¥è¿‡ç¨‹

æ£€æŸ¥è„šæœ¬å‘ç°ä½¿ç”¨äº† `set -e`ï¼Œè¿™ä¼šåœ¨é‡åˆ°éé›¶é€€å‡ºç æ—¶ç»ˆæ­¢è„šæœ¬ã€‚

é—®é¢˜ä»£ç ï¼š
```bash
set -e
SUCCESS_COUNT=0
# ... å¾ªç¯ä¸­ ...
((SUCCESS_COUNT++))  # é—®é¢˜åœ¨è¿™é‡Œï¼
```

### æ ¹æœ¬åŸå› 

**Bash çš„ç»å…¸é™·é˜±**: `set -e` ä¸ `((count++))` çš„ç»„åˆ

```bash
SUCCESS_COUNT=0
((SUCCESS_COUNT++))  # 0++ = 0ï¼Œè¢«è§†ä¸º false
                      # è¿”å›é€€å‡ºç  1
                      # set -e æ•è·åˆ°éé›¶é€€å‡ºç ï¼Œç»ˆæ­¢è„šæœ¬ï¼
```

åœ¨ Bash ä¸­ï¼Œç®—æœ¯è¡¨è¾¾å¼ `((expr))` çš„é€€å‡ºç è§„åˆ™ï¼š
- è¡¨è¾¾å¼ç»“æœä¸º 0 â†’ é€€å‡ºç  1 (false)
- è¡¨è¾¾å¼ç»“æœé 0 â†’ é€€å‡ºç  0 (true)

å½“ `SUCCESS_COUNT=0` æ—¶ï¼Œ`((SUCCESS_COUNT++))` å…ˆè¿”å›å½“å‰å€¼ 0ï¼Œç„¶åè‡ªå¢ã€‚è¿”å›å€¼ 0 è¢«è§†ä¸º falseï¼Œå¯¼è‡´é€€å‡ºç ä¸º 1ã€‚

### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: ä½¿ç”¨ç®—æœ¯æ‰©å±•ï¼ˆæ¨èï¼‰**
```bash
SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
```

**æ–¹æ¡ˆ 2: ä½¿ç”¨å‰ç¼€è‡ªå¢**
```bash
((++SUCCESS_COUNT))  # å…ˆåŠ å†è¿”å›ï¼Œç»“æœä¸º 1ï¼Œé€€å‡ºç ä¸º 0
```

**æ–¹æ¡ˆ 3: æ·»åŠ  || trueï¼ˆä¸æ¨èï¼‰**
```bash
((SUCCESS_COUNT++)) || true  # éšè—äº†é—®é¢˜
```

### ä¿®å¤åçš„ä»£ç 

```bash
# ä¿®å¤å‰
((SUCCESS_COUNT++))
((FAILED_COUNT++))

# ä¿®å¤å
SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
FAILED_COUNT=$((FAILED_COUNT + 1))
```

### ç»éªŒæ€»ç»“

> **åœ¨ `set -e` ç¯å¢ƒä¸‹ï¼Œæ°¸è¿œä¸è¦ä½¿ç”¨åç¼€è‡ªå¢ `((var++))`ï¼Œæ”¹ç”¨ `var=$((var + 1))`**

---

## é—®é¢˜ 3: Cron ä»»åŠ¡æ— æ³•è·å–ç¯å¢ƒå˜é‡

### ç°è±¡æè¿°

æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬æ­£å¸¸ï¼Œä½† Cron å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶å…‹éš†å¤±è´¥ï¼š
```
fatal: could not read Username for 'https://...': No such device or address
```

### æ ¹æœ¬åŸå› 

Cron ä»»åŠ¡è¿è¡Œåœ¨æœ€å°åŒ–ç¯å¢ƒä¸­ï¼Œä¸ä¼šè‡ªåŠ¨åŠ è½½ `/etc/environment`ï¼Œå¯¼è‡´ `GIT_TOKEN` ç¯å¢ƒå˜é‡ä¸å¯ç”¨ã€‚

### è§£å†³æ–¹æ¡ˆ

åœ¨è„šæœ¬å¼€å¤´æ·»åŠ ç¯å¢ƒå˜é‡åŠ è½½ï¼š
```bash
#!/bin/bash
# åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆCron ä»»åŠ¡å¿…éœ€ï¼‰
[ -f /etc/environment ] && source /etc/environment

# åç»­è„šæœ¬...
```

---

## äº‘æ•ˆ API è°ƒç”¨ç»éªŒ

### æ­£ç¡®çš„æœåŠ¡æ¥å…¥ç‚¹

ç»è¿‡å¤šæ¬¡å°è¯•ï¼Œå‘ç°äº‘æ•ˆ Codeup API çš„æ­£ç¡® domain æ˜¯ï¼š

```
openapi-rdc.aliyuncs.com
```

**é”™è¯¯çš„ domain**ï¼ˆéƒ½ä¼šè¿”å› 404 æˆ–é‡å®šå‘ï¼‰ï¼š
- âŒ `codeup.aliyun.com` - Web ç•Œé¢åœ°å€
- âŒ `codeup.cn-hangzhou.aliyuncs.com` - SDK ä¸“ç”¨
- âŒ `devops.cn-hangzhou.aliyuncs.com` - å…¶ä»–æœåŠ¡

### æ­£ç¡®çš„ API è°ƒç”¨æ–¹å¼

```bash
curl -s "https://openapi-rdc.aliyuncs.com/oapi/v1/codeup/organizations/${ORG_ID}/repositories?page=1&perPage=100" \
  -H "Content-Type: application/json" \
  -H "x-yunxiao-token: ${TOKEN}"
```

### è®¤è¯æ–¹å¼å¯¹æ¯”

| è®¤è¯æ–¹å¼ | é€‚ç”¨åœºæ™¯ | è¯´æ˜ |
|----------|----------|------|
| ä¸ªäººè®¿é—®ä»¤ç‰Œ | API è°ƒç”¨ã€Git å…‹éš† | é€šè¿‡ `x-yunxiao-token` header |
| AK&SK | SDK è°ƒç”¨ | éœ€è¦å…³è”äº‘æ•ˆè´¦å·ï¼Œä½¿ç”¨ç­¾åè®¤è¯ |

---

## ä»Šæ—¥æˆæœ

1. âœ… ä¿®å¤é’‰é’‰æ—¥æŠ¥æ•°æ®ä¸º 0 çš„é—®é¢˜
2. âœ… ä¿®å¤ `auto-clone-repos.sh` åªå…‹éš†ä¸€ä¸ªä»“åº“çš„ Bug
3. âœ… åˆ›å»º `sync-repos-list.py` è‡ªåŠ¨å‘ç°è„šæœ¬
4. âœ… å‘ç°äº‘æ•ˆ API æ­£ç¡®çš„æœåŠ¡æ¥å…¥ç‚¹
5. âœ… ä»“åº“ç›‘æ§ä» 9 ä¸ªæ‰©å±•åˆ° 21 ä¸ª

---

## ç›¸å…³æ–‡ä»¶

- `scripts/auto-clone-repos.sh` - ä¿®å¤ `set -e` å…¼å®¹é—®é¢˜
- `scripts/sync-repos-list.py` - æ–°å¢è‡ªåŠ¨å‘ç°è„šæœ¬
- `daily-prepare.sh` - æ·»åŠ ç¯å¢ƒå˜é‡åŠ è½½

---

**è®°å½•æ—¶é—´**: 2026-01-08
**æ’æŸ¥è€—æ—¶**: çº¦ 2 å°æ—¶
**æ ¸å¿ƒæ”¶è·**: Bash `set -e` ä¸ `(())` çš„é™·é˜±
