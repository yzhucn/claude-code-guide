# Bug 修复工作流 | Bug Fixing Workflow

> 与 Claude Code 协作的完整 Bug 修复流程
> Complete bug fixing workflow with Claude Code

---

## 🔄 完整工作流

### Phase 1: Bug 发现

**人类职责**：
- 🔍 发现异常现象
- 📝 记录错误信息
- 🎯 确定影响范围

**示例**：
```
发现问题：日报中"加班提交"次数显示为空
错误表现：字段值为空，期望显示数字
影响：所有日报推送
```

---

### Phase 2: 问题定位

**与 Claude Code 协作**：

**人类提供信息**：
```
我遇到一个 Bug：[描述现象]

相关文件：
- scripts/send-to-dingtalk.sh
- 可能在第 30-40 行附近

环境：macOS 13.0, Bash 脚本

请帮我分析可能的原因
```

**Claude Code 分析**：
- 定位问题代码
- 分析可能原因
- 提供调试建议

**人类验证**：
- 运行调试命令
- 确认问题位置
- 补充细节信息

---

### Phase 3: 解决方案

**Claude Code 提供方案**：
```markdown
## 问题原因
1. grep "加班" 模糊匹配
2. macOS 不支持 grep -oP

## 建议修复
```bash
# 方案 1: 精确匹配
OVERTIME=$(grep "加班提交" "$FILE" | sed -E 's/.*: ([0-9]+).*/\1/')

# 方案 2: 使用 awk
OVERTIME=$(awk '/加班提交:/{print $2}' "$FILE")
```
```

**人类决策**：
- 评估方案优劣
- 选择最合适方案
- 考虑兼容性要求

---

### Phase 4: 实施修复

**人类应用代码**：
```bash
# 1. 备份原文件
cp scripts/send-to-dingtalk.sh scripts/send-to-dingtalk.sh.bak

# 2. 应用修复
vim scripts/send-to-dingtalk.sh
```

**Claude Code 辅助**：
- 生成完整补丁
- 提供测试用例
- 建议验证步骤

---

### Phase 5: 测试验证

**测试清单**：
```markdown
- [ ] 本地测试（有加班数据）
- [ ] 本地测试（无加班数据）
- [ ] macOS 测试
- [ ] Linux 测试
- [ ] 边界情况测试
```

**人类执行**：
```bash
# 测试 1: 有加班数据
./send-to-dingtalk.sh 2026-01-04

# 测试 2: 无加班数据
./send-to-dingtalk.sh 2026-01-03

# 测试 3: 不同环境
ssh user@linux-server "cd /path && ./send-to-dingtalk.sh"
```

---

### Phase 6: 知识记录

**Claude Code 协助整理**：

**提示**：
```
请帮我整理这个 Bug 的完整记录：

问题：[描述]
原因：[分析]
修复：[代码对比]
测试：[验证结果]

按照 Bug 记录模板格式输出
```

**人类补充**：
- 添加截图
- 补充经验总结
- 标注关键要点

---

## 💡 协作技巧

### Tip 1: 提供完整上下文

**不够好**：
```
有个 Bug，帮我看看
```

**更好**：
```
Bug 描述：日报"加班提交"显示为空

环境信息：
- OS: macOS 13.0
- Shell: Bash 5.2
- 相关文件: scripts/send-to-dingtalk.sh

错误表现：
- 期望: "加班提交: 3 次"
- 实际: "加班提交:  次"

请帮我分析原因
```

---

### Tip 2: 迭代式调试

**第一轮**：定位问题范围
```
请帮我检查 send-to-dingtalk.sh 中
处理"加班提交"的代码逻辑
```

**第二轮**：深入分析
```
grep "加班" 这行可能有问题，
请分析在什么情况下会提取失败
```

**第三轮**：解决方案
```
请提供跨平台兼容的修复方案，
需要支持 macOS 和 Linux
```

---

### Tip 3: 要求测试用例

```
请为这个修复提供测试用例：

1. 正常情况（有加班数据）
2. 边界情况（无加班数据）
3. 异常情况（数据格式错误）

包含测试命令和期望输出
```

---

## 📋 模板提示词

### 问题分析模板
```
我遇到一个 Bug：[描述现象]

环境信息：
- OS: [操作系统]
- 语言/框架: [技术栈]
- 相关文件: [文件路径]

错误信息：
```
[粘贴错误日志]
```

请帮我：
1. 分析可能的原因
2. 定位问题代码位置
3. 提供调试建议
```

---

### 解决方案模板
```
问题原因已确认：[原因描述]

请提供修复方案，要求：
1. [要求 1，如：跨平台兼容]
2. [要求 2，如：性能优化]
3. [要求 3，如：向后兼容]

请提供：
- 修复代码
- 代码对比（diff 格式）
- 改进说明
```

---

### 测试验证模板
```
请为以下修复提供完整的测试方案：

修复内容：[简述修复]

需要覆盖：
1. 正常场景
2. 边界场景
3. 异常场景

输出：
- 测试命令
- 测试数据
- 期望结果
```

---

## 🎯 常见场景

### 场景 1: 逻辑错误

**问题类型**：代码逻辑不正确

**协作流程**：
1. 人类提供错误现象
2. AI 分析逻辑问题
3. 人类确认问题点
4. AI 提供修复方案
5. 人类测试验证

---

### 场景 2: 兼容性问题

**问题类型**：跨平台/跨版本兼容

**协作流程**：
1. 人类报告特定环境的问题
2. AI 分析兼容性差异
3. AI 提供兼容方案
4. 人类在多环境测试

**示例**：
```
macOS grep 不支持 -P 参数
→ AI 建议使用 sed -E
→ 人类在 macOS 和 Linux 验证
```

---

### 场景 3: 性能问题

**问题类型**：代码运行缓慢

**协作流程**：
1. 人类提供性能数据
2. AI 分析性能瓶颈
3. AI 提供优化方案
4. 人类对比优化效果

---

## ✅ 质量检查清单

### 修复前
- [ ] 问题根因已明确
- [ ] 影响范围已评估
- [ ] 修复方案已确定

### 修复后
- [ ] 代码已审查
- [ ] 测试已通过
- [ ] 文档已更新
- [ ] Bug 已记录

### 提交前
- [ ] Git commit 信息清晰
- [ ] 代码风格一致
- [ ] 无新增问题
- [ ] 知识库已更新

---

**创建时间**: 2026-01-05
**适用范围**: 所有 Bug 修复场景
